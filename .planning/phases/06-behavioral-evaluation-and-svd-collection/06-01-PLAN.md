---
phase: 06-behavioral-evaluation-and-svd-collection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/evaluation/__init__.py
  - src/evaluation/svd_metrics.py
  - tests/test_svd_metrics.py
autonomous: true
requirements:
  - SVD-02
  - SVD-03
  - SVD-05
  - SVD-07

must_haves:
  truths:
    - "8 SVD metric functions (stable_rank, spectral_entropy, spectral_gap_1_2, spectral_gap_2_3, spectral_gap_4_5, condition_number, rank1_residual_norm, read_write_alignment, grassmannian_distance) produce correct scalar outputs"
    - "Every metric function handles edge cases (zero singular values, near-zero denominators, NaN/Inf inputs) without producing NaN or Inf in output"
    - "guard_matrix_for_svd clamps non-finite inputs and reports guard activations"
    - "Each metric function is unit-tested against analytically known matrix decompositions"
  artifacts:
    - path: "src/evaluation/svd_metrics.py"
      provides: "8+1 SVD metric functions with numerical guards"
      exports: ["stable_rank", "spectral_entropy", "spectral_gap_1_2", "spectral_gap_2_3", "spectral_gap_4_5", "condition_number", "rank1_residual_norm", "read_write_alignment", "grassmannian_distance", "guard_matrix_for_svd", "compute_all_metrics"]
    - path: "src/evaluation/__init__.py"
      provides: "Package init with public API"
    - path: "tests/test_svd_metrics.py"
      provides: "Unit tests for all SVD metric functions against known matrices"
      min_lines: 150
  key_links:
    - from: "src/evaluation/svd_metrics.py"
      to: "torch.linalg.svd"
      via: "SVD decomposition"
      pattern: "torch\\.linalg\\.svd"
    - from: "src/evaluation/svd_metrics.py"
      to: "torch.linalg.svdvals"
      via: "Singular values only"
      pattern: "torch\\.linalg\\.svdvals"
    - from: "tests/test_svd_metrics.py"
      to: "src/evaluation/svd_metrics.py"
      via: "import and test each function"
      pattern: "from src\\.evaluation\\.svd_metrics import"
---

<objective>
Implement 8+1 pure SVD metric functions with numerical guards and comprehensive unit tests against analytically known matrices.

Purpose: These metric functions are the core measurement layer for Phase 6. They must be pure functions on tensors (singular values or U/S/Vh) so they are independently testable (SVD-07) and composable across all three SVD targets (QK^T, WvWo, AVWo). Numerical guards (SVD-05) prevent NaN/Inf from corrupting downstream analysis.

Output: `src/evaluation/svd_metrics.py` with all metric functions, `src/evaluation/__init__.py` package init, `tests/test_svd_metrics.py` with tests against identity, rank-1, diagonal, and known-condition matrices.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-behavioral-evaluation-and-svd-collection/06-RESEARCH.md
@src/model/types.py
@src/model/transformer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Create failing tests for all SVD metric functions</name>
  <files>
    tests/test_svd_metrics.py
    src/evaluation/__init__.py
    src/evaluation/svd_metrics.py
  </files>
  <action>
Create `src/evaluation/__init__.py` (empty initially) and `src/evaluation/svd_metrics.py` with stub functions that raise `NotImplementedError`.

Create `tests/test_svd_metrics.py` with the following test classes, each using analytically known matrices to verify exact outputs:

**TestStableRank:**
- Identity matrix (n x n): all singular values = 1, stable rank = n
- Rank-1 matrix (sigma_1 >> 0, rest = 0): stable rank = 1.0
- Diagonal matrix with known values: stable rank = sum(s_i^2) / s_1^2

**TestSpectralEntropy:**
- Identity matrix: all p_i equal, entropy = log(n)
- Rank-1 matrix: entropy = 0 (one dominant singular value)
- Uniform singular values [1, 1, 1]: entropy = log(3)

**TestSpectralGaps:**
- Known singular values [5, 3, 2, 1, 0.5]: gap_1_2 = 2, gap_2_3 = 1, gap_4_5 = 0.5
- All-equal singular values: all gaps = 0

**TestConditionNumber:**
- Identity: condition = 1.0
- Known diagonal [10, 1]: condition = 10.0
- Near-singular matrix (sigma_n ~ 0): condition capped at 1e6

**TestRank1ResidualNorm:**
- Rank-1 matrix: residual = 0.0
- Known SVD with s = [3, 2, 1]: residual = sqrt(4+1) / sqrt(9+4+1)

**TestReadWriteAlignment:**
- Matrix where top left and right singular vectors are identical: alignment = 1.0
- Orthogonal singular vectors: alignment = 0.0

**TestGrassmannianDistance:**
- Same subspace: distance = 0.0
- Orthogonal subspaces: distance = pi/2 * sqrt(k)

**TestNumericalGuards:**
- guard_matrix_for_svd: NaN input returns cleaned matrix + guard_activated=True
- guard_matrix_for_svd: finite input returns unchanged + guard_activated=False
- Inf input is clamped to 1e6
- Zero singular values don't cause NaN in any metric

**TestBatchedSVD:**
- Batched input [B, T, T] produces correct per-element metrics
- Verify shapes match expected output shapes

**TestComputeAllMetrics:**
- compute_all_metrics returns dict with all 7 metric keys
- Values match individual function outputs

All tests should construct torch tensors with known SVD decompositions. Use `torch.linalg.svd` to verify the test matrices have the expected singular values, OR construct from known U @ diag(S) @ Vh.

Run tests -- they must ALL FAIL (RED phase). Commit: `test(06-01): add failing tests for SVD metric functions`
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -m pytest tests/test_svd_metrics.py -x 2>&1 | tail -5</automated>
    <manual>All tests fail with NotImplementedError or ImportError (RED phase)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>tests/test_svd_metrics.py exists with 20+ tests covering all 8+1 metric functions and numerical guards, all failing against stubs</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement all SVD metric functions with numerical guards</name>
  <files>
    src/evaluation/svd_metrics.py
    src/evaluation/__init__.py
  </files>
  <action>
Implement all functions in `src/evaluation/svd_metrics.py`:

**Constants:**
- `EPS = 1e-12` (epsilon for all denominators)
- `CONDITION_CAP = 1e6` (condition number cap per spec)

**Pre-SVD guard:**
- `guard_matrix_for_svd(M: torch.Tensor) -> tuple[torch.Tensor, bool]`: Check `torch.isfinite(M).all()`. If false, apply `torch.nan_to_num(M, nan=0.0, posinf=1e6, neginf=-1e6)`. Return (cleaned_matrix, guard_activated).

**Metrics taking singular values S (use torch.linalg.svdvals where only S needed):**
- `stable_rank(S) -> Tensor`: `s_sq.sum(-1) / (s_sq[..., 0] + EPS)`
- `spectral_entropy(S) -> Tensor`: `p = S / (S.sum(-1, keepdim=True) + EPS)`, `ent = -(p * log(p + EPS)).sum(-1)`, `clamp(ent, min=0.0)`
- `spectral_gap_1_2(S) -> Tensor`: `S[..., 0] - S[..., 1]`
- `spectral_gap_2_3(S) -> Tensor`: `S[..., 1] - S[..., 2]`
- `spectral_gap_4_5(S) -> Tensor`: `S[..., 3] - S[..., 4]`
- `condition_number(S) -> Tensor`: `clamp(S[..., 0] / (S[..., -1] + EPS), max=CONDITION_CAP)`

**Metrics requiring full SVD (U, S, Vh):**
- `rank1_residual_norm(U, S, Vh) -> Tensor`: `sqrt(S[..., 1:]**2 .sum(-1) + EPS) / (sqrt(S**2 .sum(-1) + EPS) + EPS)`
- `read_write_alignment(U, Vh) -> Tensor`: `abs(sum(U[..., :, 0] * Vh[..., 0, :], dim=-1))` (WvWo only, cosine angle between top-1 left and right singular vectors)
- `grassmannian_distance(U_prev, U_curr, k=2) -> Tensor`: `svdvals(U_prev[..., :, :k].T @ U_curr[..., :, :k])`, clamp to [-1, 1], arccos, sqrt of sum of squared angles

**Convenience:**
- `compute_all_metrics(S, U=None, Vh=None) -> dict[str, Tensor]`: Compute all 7 singular-value metrics. If U and Vh provided, also compute rank1_residual_norm and read_write_alignment. Return dict keyed by metric name.

Update `src/evaluation/__init__.py` to export all public functions.

Run all tests -- they must ALL PASS (GREEN phase). Commit: `feat(06-01): implement SVD metric functions with numerical guards`
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -m pytest tests/test_svd_metrics.py -x -v</automated>
    <manual>All tests pass, no warnings about NaN or numerical issues</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All SVD metric tests pass green. Functions handle batched input, edge cases (zero singular values, NaN/Inf), and produce correct results for analytically known matrices. Full test suite (168+ existing tests) has zero regressions.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_svd_metrics.py -v` -- all tests pass
2. `pytest tests/ -x` -- full suite passes with zero regressions
3. Each of the 8+1 metric functions has at least one test against a known analytical result
4. Numerical guards are tested with NaN, Inf, and near-zero inputs
5. Batched inputs produce correct per-element results
</verification>

<success_criteria>
- All 8+1 SVD metric functions implemented as pure functions on tensors
- Each function tested against analytically known matrices (SVD-07)
- Numerical guards prevent NaN/Inf in all outputs (SVD-05)
- torch.linalg.svd used with full_matrices=False (SVD-02)
- compute_all_metrics convenience function returns all 7 metrics
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-behavioral-evaluation-and-svd-collection/06-01-SUMMARY.md`
</output>
