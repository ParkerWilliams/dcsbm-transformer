---
phase: 09-reporting-and-math-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reporting/__init__.py
  - src/reporting/embed.py
  - src/reporting/reproduction.py
  - src/reporting/single.py
  - src/reporting/templates/single_report.html
  - tests/test_reporting.py
autonomous: true
requirements:
  - REPT-01
  - REPT-03

must_haves:
  truths:
    - "A single-experiment HTML report is generated as a self-contained file with no external dependencies"
    - "All figures from the experiment are embedded as base64 data URIs in the HTML"
    - "The report contains structured configuration tables grouped by category (model, training, data)"
    - "The report includes a reproduction block with git checkout command, CLI arguments, and seed"
    - "Sections with missing data display 'Not available' placeholders instead of being hidden"
    - "The reproduction block has a copy button that copies the command to clipboard"
  artifacts:
    - path: "src/reporting/embed.py"
      provides: "Base64 figure embedding utility"
      exports: ["embed_figure"]
    - path: "src/reporting/reproduction.py"
      provides: "Reproduction block builder from result.json metadata"
      exports: ["build_reproduction_block"]
    - path: "src/reporting/single.py"
      provides: "Single-experiment HTML report generator"
      exports: ["generate_single_report"]
    - path: "src/reporting/templates/single_report.html"
      provides: "Jinja2 HTML template with academic style"
      contains: "font-family"
    - path: "tests/test_reporting.py"
      provides: "Test coverage for reporting module"
      min_lines: 50
  key_links:
    - from: "src/reporting/single.py"
      to: "src/visualization/render.py"
      via: "load_result_data for experiment data"
      pattern: "load_result_data"
    - from: "src/reporting/single.py"
      to: "src/reporting/embed.py"
      via: "embed_figure for base64 encoding"
      pattern: "embed_figure"
    - from: "src/reporting/single.py"
      to: "src/reporting/reproduction.py"
      via: "build_reproduction_block for repro section"
      pattern: "build_reproduction_block"
    - from: "src/reporting/single.py"
      to: "src/reporting/templates/single_report.html"
      via: "Jinja2 FileSystemLoader template rendering"
      pattern: "FileSystemLoader"
---

<objective>
Build the single-experiment HTML report generator with base64 figure embedding, structured config tables, reproduction block, and academic styling.

Purpose: Delivers REPT-01 (self-contained single-experiment report) and REPT-03 (reproduction block in every report). Creates the shared embed.py and reproduction.py utilities that Plan 02 (comparison report) will also use.
Output: `src/reporting/` module with single report generation, embed utilities, reproduction block builder, Jinja2 template, and tests.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-reporting-and-math-verification/09-CONTEXT.md
@.planning/phases/09-reporting-and-math-verification/09-RESEARCH.md
@src/visualization/render.py
@src/results/schema.py
@src/reproducibility/git_hash.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embed, reproduction, and report module scaffolding</name>
  <files>
    src/reporting/__init__.py
    src/reporting/embed.py
    src/reporting/reproduction.py
    src/reporting/templates/single_report.html
  </files>
  <action>
Create the `src/reporting/` package with three files:

1. **`src/reporting/__init__.py`**: Export `generate_single_report`, `embed_figure`, `build_reproduction_block`.

2. **`src/reporting/embed.py`**: Single function `embed_figure(fig_path: Path) -> str` that reads a PNG or SVG file, base64-encodes it, and returns a `data:{mime};base64,{data}` URI string. Detect MIME from suffix: `.png` -> `image/png`, `.svg` -> `image/svg+xml`. Return empty string if file does not exist (don't crash on missing figures).

3. **`src/reporting/reproduction.py`**: Function `build_reproduction_block(result: dict) -> dict` that extracts from result.json:
   - `metadata.code_hash` (may end with `-dirty`)
   - `config.seed`
   - Builds `checkout_cmd = f"git checkout {clean_hash}"` (strip `-dirty` suffix)
   - Builds `run_cmd` with the seed and key config params
   - Returns dict with keys: `checkout_cmd`, `run_cmd`, `seed`, `is_dirty`, `dirty_warning` (string or None)
   - Per user decision: git commit hash captured at experiment runtime (from result.json), NOT at report generation time
   - Per user decision: dirty repo flagged with warning string

4. **`src/reporting/templates/single_report.html`**: Jinja2 template with academic style per user decisions:
   - Serif fonts (Georgia, Times New Roman), paper-like feel, max-width 900px centered
   - Sections: Header (experiment_id, timestamp, description), Configuration (tables grouped by model/training/data categories), Scalar Metrics (table), Training Curves (figure), Confusion Matrix (figure), AUROC Curves (figures), Event-Aligned Plots (figures), Distribution Plots (figures), Statistical Tests (table with p-values, CIs, effect sizes), Sequence Analysis (placeholder), Reproduction Block
   - Full-width figures, one per row (per user decision: no side-by-side grids)
   - Each section uses `{% if %}` conditionals: if data present, render it; if missing, show `<p class="not-available">Not available</p>` (per user decision: don't hide missing sections)
   - Config tables: iterate over `config_tables` dict where keys are category names (Model, Training, Data) and values are lists of {name, value} dicts (per user decision: structured HTML tables, not raw JSON)
   - Reproduction block: `<pre>` with copy button using `navigator.clipboard.writeText()` with textarea fallback
   - Per user decision: dirty warning shown as orange text above repro command
   - CSS: `.not-available { color: #999; font-style: italic; }`, `.dirty-warning { color: #cc6600; font-weight: bold; }`, `.diff-highlight { background: #fff3cd; }`, table borders `1px solid #ccc`, header bg `#f5f5f5`
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -c "from src.reporting.embed import embed_figure; from src.reporting.reproduction import build_reproduction_block; print('imports ok')"</automated>
  </verify>
  <done>embed.py returns valid data URIs for PNG/SVG files; reproduction.py extracts git hash and builds reproduction command from result dict; HTML template exists with all required sections and academic styling</done>
</task>

<task type="auto">
  <name>Task 2: Implement single-experiment report generator with tests</name>
  <files>
    src/reporting/single.py
    src/reporting/__init__.py
    tests/test_reporting.py
  </files>
  <action>
Create `src/reporting/single.py` with function `generate_single_report(result_dir: str | Path, output_path: str | Path | None = None) -> Path`:

1. Load experiment data using `load_result_data(result_dir)` from `src.visualization.render`.
2. Build `config_tables` dict by categorizing config parameters into groups:
   - "Model": d_model, n_layers, n_heads, vocab_size
   - "Training": learning_rate, num_epochs, batch_size, w (context window), seed
   - "Data": n (vertices), K (blocks), p_in, p_out, walk_length, corpus_size
   - Use `.get()` with defaults for all fields to handle missing config gracefully
3. Collect figures from `{result_dir}/figures/` directory. For each PNG file found, call `embed_figure()` to get data URI. Build list of `{title, data_uri}` dicts. Title derived from filename (e.g., `training_curves.png` -> "Training Curves").
4. Extract scalar metrics from `result["metrics"]["scalars"]` using `.get({}, {})` chains.
5. Extract statistical test results from `result["metrics"]` -- look for `predictive_horizon`, `statistical_controls` keys.
6. Build reproduction block via `build_reproduction_block(result)`.
7. Create Jinja2 Environment with `FileSystemLoader` pointing to `src/reporting/templates/`, `autoescape=select_autoescape(["html"])`, `trim_blocks=True`, `lstrip_blocks=True`.
8. Render `single_report.html` template with all data.
9. Write to `output_path` (default: `{result_dir}/report.html`).
10. Return the output path.

Create `tests/test_reporting.py` with tests:
- `test_embed_figure_png`: Create temp PNG, verify embed returns valid data URI starting with `data:image/png;base64,`
- `test_embed_figure_svg`: Create temp SVG, verify embed returns valid data URI with `image/svg+xml`
- `test_embed_figure_missing`: Verify returns empty string for nonexistent path
- `test_reproduction_block_clean`: Build block from result dict with clean hash, verify checkout_cmd, run_cmd, is_dirty=False
- `test_reproduction_block_dirty`: Build block from result dict with dirty hash, verify is_dirty=True, dirty_warning present
- `test_generate_single_report`: Create minimal result_dir with result.json + figures/, call generate_single_report(), verify HTML file created, contains key strings ("Configuration", "Reproduction", base64 data URI prefix)
- `test_generate_single_report_missing_sections`: Create result_dir with minimal result.json (no figures, no metrics beyond scalars), verify report generates with "Not available" placeholders

Update `__init__.py` to export `generate_single_report`.
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -m pytest tests/test_reporting.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>generate_single_report() produces a self-contained HTML file with base64-embedded figures, structured config tables, scalar metrics, statistical test results, and copy-pasteable reproduction block; all 7 tests pass</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_reporting.py -x -v` -- all tests pass
2. `python -c "from src.reporting import generate_single_report, embed_figure, build_reproduction_block"` -- imports work
3. Manual: generated HTML opens in browser, figures display inline, copy button works, no external file references
</verification>

<success_criteria>
- generate_single_report() produces self-contained HTML with base64-embedded figures (REPT-01)
- Report includes reproduction block with git checkout + CLI args + seed (REPT-03)
- Config displayed as structured tables grouped by category, not raw JSON
- Missing sections show "Not available" placeholders
- All tests in test_reporting.py pass
- embed.py and reproduction.py are reusable for Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/09-reporting-and-math-verification/09-01-SUMMARY.md`
</output>
