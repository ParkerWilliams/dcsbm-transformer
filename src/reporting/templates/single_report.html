<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ experiment_id }} - Experiment Report</title>
  <style>
    /* Academic style: serif fonts, paper-like feel */
    body {
      font-family: Georgia, "Times New Roman", Times, serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 2em 1.5em;
      background: #fff;
      color: #333;
      line-height: 1.6;
    }

    h1 {
      font-size: 1.8em;
      border-bottom: 2px solid #333;
      padding-bottom: 0.3em;
      margin-bottom: 0.5em;
    }

    h2 {
      font-size: 1.4em;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.2em;
      margin-top: 2em;
    }

    h3 {
      font-size: 1.15em;
      margin-top: 1.5em;
    }

    .header-meta {
      color: #666;
      font-size: 0.95em;
      margin-bottom: 1.5em;
    }

    .header-meta p {
      margin: 0.2em 0;
    }

    /* Tables */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
      font-size: 0.95em;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.5em 0.8em;
      text-align: left;
    }

    th {
      background: #f5f5f5;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    /* Figures */
    .figure-container {
      margin: 1.5em 0;
      text-align: center;
    }

    .figure-container img {
      max-width: 100%;
      height: auto;
    }

    .figure-container .figure-title {
      font-weight: bold;
      margin-bottom: 0.5em;
      font-size: 1.05em;
    }

    /* Not available placeholder */
    .not-available {
      color: #999;
      font-style: italic;
    }

    /* Dirty warning */
    .dirty-warning {
      color: #cc6600;
      font-weight: bold;
    }

    /* Diff highlight for comparison reports */
    .diff-highlight {
      background: #fff3cd;
    }

    /* Reproduction block */
    .repro-block {
      position: relative;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1em;
      margin: 1em 0;
    }

    .repro-block pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: "Courier New", Courier, monospace;
      font-size: 0.9em;
    }

    .copy-btn {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      background: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 0.3em 0.8em;
      cursor: pointer;
      font-size: 0.85em;
      font-family: sans-serif;
    }

    .copy-btn:hover {
      background: #d0d0d0;
    }

    /* Collapsible enrichment sections (Phase 13) */
    details.enrichment-section {
      margin-top: 2em;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 0;
    }
    details.enrichment-section summary {
      padding: 0.8em 1em;
      background: #f5f5f5;
      cursor: pointer;
      list-style: none;
      font-size: 1.2em;
      font-weight: bold;
    }
    details.enrichment-section summary::-webkit-details-marker { display: none; }
    details.enrichment-section summary::before {
      content: "+ ";
      font-weight: bold;
      margin-right: 0.3em;
    }
    details.enrichment-section[open] summary::before {
      content: "- ";
    }
    details.enrichment-section .section-content {
      padding: 1em;
    }

    /* Footer */
    .report-footer {
      margin-top: 3em;
      padding-top: 1em;
      border-top: 1px solid #ccc;
      color: #999;
      font-size: 0.85em;
      text-align: center;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <h1>Experiment Report</h1>
  <div class="header-meta">
    <p><strong>Experiment ID:</strong> {{ experiment_id }}</p>
    {% if timestamp %}
    <p><strong>Timestamp:</strong> {{ timestamp }}</p>
    {% endif %}
    {% if description %}
    <p><strong>Description:</strong> {{ description }}</p>
    {% endif %}
  </div>

  <!-- Configuration -->
  <h2>Configuration</h2>
  {% if config_tables %}
  {% for category, params in config_tables.items() %}
  <h3>{{ category }}</h3>
  <table>
    <thead>
      <tr><th>Parameter</th><th>Value</th></tr>
    </thead>
    <tbody>
      {% for param in params %}
      <tr>
        <td>{{ param.name }}</td>
        <td>{{ param.value }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endfor %}
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Scalar Metrics -->
  <h2>Scalar Metrics</h2>
  {% if scalar_metrics %}
  <table>
    <thead>
      <tr><th>Metric</th><th>Value</th></tr>
    </thead>
    <tbody>
      {% for name, value in scalar_metrics.items() %}
      <tr>
        <td>{{ name }}</td>
        <td>{{ "%.6f"|format(value) if value is number else value }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Training Curves -->
  <h2>Training Curves</h2>
  {% if training_curves_figure %}
  <div class="figure-container">
    <img src="{{ training_curves_figure }}" alt="Training Curves">
  </div>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Confusion Matrix -->
  <h2>Confusion Matrix</h2>
  {% if confusion_matrix_figure %}
  <div class="figure-container">
    <img src="{{ confusion_matrix_figure }}" alt="Confusion Matrix">
  </div>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- AUROC Curves -->
  <h2>AUROC Curves</h2>
  {% if auroc_figures %}
  {% for fig in auroc_figures %}
  <div class="figure-container">
    <div class="figure-title">{{ fig.title }}</div>
    <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
  </div>
  {% endfor %}
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- PR Curves (PRCL-01, PRCL-03) -->
  {% if pr_curves or pr_curve_figures %}
  <details class="enrichment-section">
    <summary>Precision-Recall Curves</summary>
    <div class="section-content">
      {% if pr_curves and pr_curves.by_r_value %}
      <h3>AUPRC Summary</h3>
      <table>
        <thead>
          <tr>
            <th>r-value</th>
            <th>Metric</th>
            <th>AUPRC (by lookback j=1..r)</th>
            <th>Prevalence</th>
          </tr>
        </thead>
        <tbody>
          {% for r_str, r_data in pr_curves.by_r_value|dictsort %}
          {% if r_data.by_metric %}
          {% for metric_name, m_data in r_data.by_metric|dictsort %}
          <tr>
            <td>{{ r_str }}</td>
            <td>{{ metric_name }}</td>
            <td>
              {% if m_data.auprc_by_lookback %}
              {% for v in m_data.auprc_by_lookback %}{{ "%.4f"|format(v) if v is number else 'NaN' }}{% if not loop.last %}, {% endif %}{% endfor %}
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>{{ "%.4f"|format(m_data.prevalence) if m_data.prevalence is number else 'N/A' }}</td>
          </tr>
          {% endfor %}
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% if pr_curve_figures %}
      <h3>PR Curve Plots</h3>
      {% for fig in pr_curve_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Calibration Diagnostics (PRCL-02, PRCL-03) -->
  {% if calibration or calibration_figures %}
  <details class="enrichment-section">
    <summary>Calibration Diagnostics</summary>
    <div class="section-content">
      {% if calibration and calibration.by_r_value %}
      <h3>ECE Summary</h3>
      <table>
        <thead>
          <tr>
            <th>r-value</th>
            <th>Metric</th>
            <th>ECE (by lookback j=1..r)</th>
          </tr>
        </thead>
        <tbody>
          {% for r_str, r_data in calibration.by_r_value|dictsort %}
          {% if r_data.by_metric %}
          {% for metric_name, m_data in r_data.by_metric|dictsort %}
          <tr>
            <td>{{ r_str }}</td>
            <td>{{ metric_name }}</td>
            <td>
              {% if m_data.ece_by_lookback %}
              {% for v in m_data.ece_by_lookback %}{{ "%.4f"|format(v) if v is number else 'NaN' }}{% if not loop.last %}, {% endif %}{% endfor %}
              {% else %}
              N/A
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% if calibration_figures %}
      <h3>Reliability Diagrams</h3>
      {% for fig in calibration_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- SVD Computational Cost (OVHD-01, OVHD-02, OVHD-03) -->
  {% if svd_benchmark %}
  <details class="enrichment-section">
    <summary>SVD Computational Cost</summary>
    <div class="section-content">
      {% if svd_benchmark.by_target %}
      <h3>Cost Summary</h3>
      <table>
        <thead>
          <tr>
            <th>Target</th>
            <th>Matrix Size</th>
            <th>Full SVD (ms)</th>
            <th>Randomized SVD (ms)</th>
            <th>Values-only SVD (ms)</th>
            <th>Rand. Frob. Error</th>
            <th>Rand. SV Corr.</th>
          </tr>
        </thead>
        <tbody>
          {% for target_name, t_data in svd_benchmark.by_target|dictsort %}
          <tr>
            <td>{{ target_name }}</td>
            <td>{{ t_data.matrix_shape | join(' x ') if t_data.matrix_shape else 'N/A' }}</td>
            <td>{{ "%.3f"|format(t_data.full_svd_ms) if t_data.full_svd_ms is number else 'N/A' }}</td>
            <td>{{ "%.3f"|format(t_data.randomized_svd_ms) if t_data.randomized_svd_ms is number else 'N/A' }}</td>
            <td>{{ "%.3f"|format(t_data.values_only_ms) if t_data.values_only_ms is number else 'N/A' }}</td>
            <td>{{ "%.6f"|format(t_data.randomized_frob_error) if t_data.randomized_frob_error is number else 'N/A' }}</td>
            <td>{{ "%.6f"|format(t_data.randomized_sv_correlation) if t_data.randomized_sv_correlation is number else 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      {% if svd_benchmark.summary %}
      <p>
        <strong>Total SVD cost per step:</strong> {{ "%.3f"|format(svd_benchmark.summary.total_svd_ms_per_step) }} ms.
        <strong>Fastest method:</strong> {{ svd_benchmark.summary.fastest_method }}.
      </p>
      {% endif %}

      {% if svd_benchmark_figures %}
      <h3>Benchmark Plots</h3>
      {% for fig in svd_benchmark_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Softmax Filtering Bound (SFTX-02, SFTX-03) -->
  {% if perturbation_bound or perturbation_bound_figures %}
  <details class="enrichment-section">
    <summary>Softmax Filtering Bound</summary>
    <div class="section-content">
      {% if perturbation_bound %}
      <h3>Bound Verification Summary</h3>
      {% if perturbation_bound.by_magnitude %}
      <table>
        <thead>
          <tr>
            <th>Magnitude (&varepsilon;)</th>
            <th>Direction</th>
            <th>Mean Ratio</th>
            <th>Max Ratio</th>
            <th>Exceeding Bound</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for eps_str, eps_data in perturbation_bound.by_magnitude|dictsort %}
          <tr>
            <td rowspan="2">{{ eps_str }}</td>
            <td>Adversarial</td>
            <td>{{ "%.4f"|format(eps_data.adversarial.mean_ratio) if eps_data.adversarial.mean_ratio is number else 'N/A' }}</td>
            <td>{{ "%.4f"|format(eps_data.adversarial.max_ratio) if eps_data.adversarial.max_ratio is number else 'N/A' }}</td>
            <td>{{ eps_data.adversarial.n_exceeding_bound }}</td>
            <td>{{ eps_data.adversarial.n_total }}</td>
          </tr>
          <tr>
            <td>Random</td>
            <td>{{ "%.4f"|format(eps_data.random.mean_ratio) if eps_data.random.mean_ratio is number else 'N/A' }}</td>
            <td>{{ "%.4f"|format(eps_data.random.max_ratio) if eps_data.random.max_ratio is number else 'N/A' }}</td>
            <td>{{ eps_data.random.n_exceeding_bound }}</td>
            <td>{{ eps_data.random.n_total }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <p>
        <strong>Tightness ratio:</strong> {{ "%.4f"|format(perturbation_bound.tightness_ratio) if perturbation_bound.tightness_ratio is number else 'N/A' }}.
        <strong>Violation rate:</strong> {{ "%.4f"|format(perturbation_bound.violation_rate) if perturbation_bound.violation_rate is number else 'N/A' }}.
        <strong>Bound verified:</strong> {{ "Yes" if perturbation_bound.bound_verified else "No" }}.
      </p>
      {% endif %}

      {% if perturbation_bound_figures %}
      <h3>Bound Tightness Plots</h3>
      {% for fig in perturbation_bound_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Spectrum Trajectory Analysis (SPEC-03) -->
  {% if spectrum_analysis or spectrum_figures %}
  <details class="enrichment-section">
    <summary><strong>Spectrum Trajectory Analysis (Exploratory)</strong></summary>
    <div class="section-content">
      <p><em>Status: Exploratory analysis. Curvature and torsion metrics are secondary
      and not part of the pre-registered primary hypothesis.</em></p>

      {% if spectrum_analysis %}
      {% if spectrum_analysis.by_r_value %}
      <h3>Curvature/Torsion AUROC Summary</h3>
      <table>
        <thead>
          <tr>
            <th>r-value</th>
            <th>Metric</th>
            <th>Peak AUROC</th>
            <th>Peak Lookback</th>
          </tr>
        </thead>
        <tbody>
          {% for r_str, r_data in spectrum_analysis.by_r_value|dictsort %}
          {% for metric_name, m_data in r_data.by_metric|dictsort %}
          <tr>
            <td>{{ r_str }}</td>
            <td>{{ metric_name }}</td>
            <td>{{ "%.4f"|format(m_data.peak_auroc) if m_data.peak_auroc is number else 'N/A' }}</td>
            <td>{{ m_data.peak_lookback if m_data.peak_lookback is number else 'N/A' }}</td>
          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% endif %}

      {% if spectrum_figures %}
      <h3>Spectrum Plots</h3>
      {% for fig in spectrum_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Compliance Phase Transition (COMP-01, COMP-02) -->
  {% if compliance_curve or compliance_figures %}
  <details class="enrichment-section">
    <summary><strong>Compliance Phase Transition</strong></summary>
    <div class="section-content">
      {% if compliance_curve %}
      {% if compliance_curve.curve %}
      <h3>Compliance Summary</h3>
      <table>
        <thead>
          <tr>
            <th>r/w ratio</th>
            <th>Rule Compliance</th>
            <th>Edge Compliance</th>
            <th>Seeds</th>
          </tr>
        </thead>
        <tbody>
          {% for i in range(compliance_curve.curve.r_over_w_values|length) %}
          <tr>
            <td>{{ "%.2f"|format(compliance_curve.curve.r_over_w_values[i]) }}</td>
            <td>{{ "%.4f"|format(compliance_curve.curve.rule_compliance.mean[i]) }} &plusmn; {{ "%.4f"|format(compliance_curve.curve.rule_compliance.std[i]) }}</td>
            <td>{{ "%.4f"|format(compliance_curve.curve.edge_compliance.mean[i]) }} &plusmn; {{ "%.4f"|format(compliance_curve.curve.edge_compliance.std[i]) }}</td>
            <td>{{ compliance_curve.curve.n_seeds[i] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% endif %}

      {% if compliance_figures %}
      <h3>Compliance Curve</h3>
      {% for fig in compliance_figures %}
      <div class="figure-container">
        <div class="figure-title">{{ fig.title }}</div>
        <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
      </div>
      {% endfor %}
      {% endif %}
    </div>
  </details>
  {% endif %}

  <!-- Event-Aligned Plots -->
  <h2>Event-Aligned Plots</h2>
  {% if event_aligned_figures %}
  {% for fig in event_aligned_figures %}
  <div class="figure-container">
    <div class="figure-title">{{ fig.title }}</div>
    <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
  </div>
  {% endfor %}
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Distribution Plots -->
  <h2>Distribution Plots</h2>
  {% if distribution_figures %}
  {% for fig in distribution_figures %}
  <div class="figure-container">
    <div class="figure-title">{{ fig.title }}</div>
    <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
  </div>
  {% endfor %}
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Statistical Tests -->
  <h2>Statistical Tests</h2>
  {% if statistical_tests %}
  <table>
    <thead>
      <tr>
        <th>Metric</th>
        <th>AUROC</th>
        <th>p-value</th>
        <th>CI (95%)</th>
        <th>Effect Size (d)</th>
      </tr>
    </thead>
    <tbody>
      {% for test in statistical_tests %}
      <tr>
        <td>{{ test.metric }}</td>
        <td>{{ "%.4f"|format(test.auroc) if test.auroc is number else test.auroc }}</td>
        <td>{{ "%.4f"|format(test.p_value) if test.p_value is number else test.p_value }}</td>
        <td>
          {% if test.ci_lower is number and test.ci_upper is number %}
          [{{ "%.4f"|format(test.ci_lower) }}, {{ "%.4f"|format(test.ci_upper) }}]
          {% else %}
          {{ test.ci_lower }} - {{ test.ci_upper }}
          {% endif %}
        </td>
        <td>{{ "%.4f"|format(test.effect_size) if test.effect_size is number else test.effect_size }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Null Model Baseline -->
  {% if null_model %}
  <h2>Null Model Baseline</h2>

  <p class="summary">
    {% if null_model.aggregate.signal_exceeds_noise %}
    <strong>Signal exceeds noise:</strong> The Grassmannian drift signal at violation events
    is statistically distinguishable from the null (jumper-free) distribution.
    {{ null_model.aggregate.n_lookbacks_rejected }} of {{ null_model.aggregate.n_lookbacks_tested }}
    lookback distances rejected (Holm-Bonferroni corrected, &alpha; = {{ null_model.config.alpha }}).
    Maximum Cohen's d = {{ "%.3f"|format(null_model.aggregate.max_cohens_d) }} at lookback j={{ null_model.aggregate.max_cohens_d_lookback }}.
    {% else %}
    <strong>Signal does not exceed noise:</strong> The Grassmannian drift at violation events
    is not statistically distinguishable from the null distribution with Cohen's d &ge; 0.5.
    {% endif %}
  </p>

  <h3>Per-Lookback Statistical Comparison</h3>
  <table>
    <thead>
      <tr>
        <th>Lookback j</th>
        <th>Null (mean &plusmn; std)</th>
        <th>Violation (mean &plusmn; std)</th>
        <th>Mann-Whitney U</th>
        <th>p (raw)</th>
        <th>p (adjusted)</th>
        <th>Cohen's d</th>
        <th>Reject?</th>
      </tr>
    </thead>
    <tbody>
      {% for j, data in null_model.by_lookback|dictsort %}
      <tr>
        <td>{{ j }}</td>
        <td>{{ "%.4f"|format(data.null_mean) }} &plusmn; {{ "%.4f"|format(data.null_std) }}</td>
        <td>{{ "%.4f"|format(data.violation_mean) }} &plusmn; {{ "%.4f"|format(data.violation_std) }}</td>
        <td>{{ "%.1f"|format(data.mann_whitney_U) }}</td>
        <td>{{ "%.4f"|format(data.p_value_raw) }}</td>
        <td>{{ "%.4f"|format(data.p_value_adjusted) }}</td>
        <td>{{ "%.3f"|format(data.cohens_d) }}</td>
        <td>{{ "Yes" if data.reject else "No" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if null_model.marchenko_pastur %}
  <h3>Marchenko-Pastur Reference</h3>
  <p>
    Aspect ratio &gamma; = {{ "%.3f"|format(null_model.marchenko_pastur.gamma) }},
    &sigma;&sup2; = {{ "%.6f"|format(null_model.marchenko_pastur.sigma2) }},
    &lambda;<sub>&minus;</sub> = {{ "%.6f"|format(null_model.marchenko_pastur.lambda_minus) }},
    &lambda;<sub>+</sub> = {{ "%.6f"|format(null_model.marchenko_pastur.lambda_plus) }}.
  </p>

  <table>
    <thead>
      <tr><th>Anchor Position</th><th>KS Statistic</th><th>KS p-value</th></tr>
    </thead>
    <tbody>
      {% for pos, data in null_model.marchenko_pastur.anchor_positions|dictsort %}
      <tr>
        <td>{{ pos }}</td>
        <td>{{ "%.4f"|format(data.ks_statistic) }}</td>
        <td>{{ "%.4f"|format(data.ks_p_value) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if null_overlay_figures %}
  <h3>Null Overlay Plots</h3>
  {% for fig in null_overlay_figures %}
  <div class="figure-container">
    <div class="figure-title">{{ fig.title }}</div>
    <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
  </div>
  {% endfor %}
  {% endif %}

  {% if mp_histogram_figures %}
  <h3>Marchenko-Pastur Histograms</h3>
  {% for fig in mp_histogram_figures %}
  <div class="figure-container">
    <div class="figure-title">{{ fig.title }}</div>
    <img src="{{ fig.data_uri }}" alt="{{ fig.title }}">
  </div>
  {% endfor %}
  {% endif %}

  {% endif %}

  <!-- Predictive Horizon -->
  <h2>Predictive Horizon</h2>
  {% if predictive_horizon %}
  <table>
    <thead>
      <tr>
        <th>r-value</th>
        <th>Best Metric</th>
        <th>Best AUROC</th>
        <th>Significant</th>
      </tr>
    </thead>
    <tbody>
      {% for row in predictive_horizon %}
      <tr>
        <td>{{ row.r_value }}</td>
        <td>{{ row.best_metric }}</td>
        <td>{{ "%.4f"|format(row.best_auroc) if row.best_auroc is number else row.best_auroc }}</td>
        <td>{{ row.significant }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Sequence Analysis -->
  <h2>Sequence Analysis</h2>
  {% if sequence_analysis %}
  {{ sequence_analysis }}
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Reproduction -->
  <h2>Reproduction</h2>
  {% if reproduction %}
  {% if reproduction.dirty_warning %}
  <p class="dirty-warning">{{ reproduction.dirty_warning }}</p>
  {% endif %}

  <h3>1. Checkout code version</h3>
  <div class="repro-block">
    <button class="copy-btn" onclick="copyToClipboard(this, 'checkout-cmd')">Copy</button>
    <pre id="checkout-cmd">{{ reproduction.checkout_cmd }}</pre>
  </div>

  <h3>2. Run experiment</h3>
  <div class="repro-block">
    <button class="copy-btn" onclick="copyToClipboard(this, 'run-cmd')">Copy</button>
    <pre id="run-cmd">{{ reproduction.run_cmd }}</pre>
  </div>

  <p><strong>Seed:</strong> {{ reproduction.seed }}</p>
  {% else %}
  <p class="not-available">Not available</p>
  {% endif %}

  <!-- Footer -->
  <div class="report-footer">
    Generated by DCSBM-Transformer reporting module
  </div>

  <script>
    function copyToClipboard(btn, elementId) {
      var text = document.getElementById(elementId).textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          btn.textContent = 'Copied!';
          setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
        }).catch(function() {
          fallbackCopy(btn, text);
        });
      } else {
        fallbackCopy(btn, text);
      }
    }

    function fallbackCopy(btn, text) {
      var textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      } catch (e) {
        btn.textContent = 'Failed';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      }
      document.body.removeChild(textarea);
    }
  </script>

</body>
</html>
