---
phase: 09-reporting-and-math-verification
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/reporting/math_pdf.py
  - src/reporting/templates/math_verification.tex
  - tests/test_math_pdf.py
  - src/reporting/__init__.py
autonomous: true
requirements:
  - MATH-01
  - MATH-02

must_haves:
  truths:
    - "A .tex file is generated with title page, table of contents, and per-file math sections"
    - "Math-heavy source files get full LaTeX treatment: plain-language summary, code block, LaTeX formulas"
    - "Non-math files are listed in an appendix with filename + one-liner description"
    - "The title page has a footnote noting AI-generated LaTeX requiring researcher sign-off"
    - "If pdflatex is available, the .tex compiles to PDF; if not, a clear message is shown and the .tex is preserved"
    - "Symbols are defined in context where they first appear, not in a separate glossary"
  artifacts:
    - path: "src/reporting/math_pdf.py"
      provides: "Math verification PDF generator"
      exports: ["generate_math_pdf"]
    - path: "src/reporting/templates/math_verification.tex"
      provides: "Jinja2 LaTeX template with custom delimiters"
      contains: "\\VAR{"
    - path: "tests/test_math_pdf.py"
      provides: "Tests for math PDF generation"
      min_lines: 40
  key_links:
    - from: "src/reporting/math_pdf.py"
      to: "src/reporting/templates/math_verification.tex"
      via: "Jinja2 with LaTeX-safe delimiters"
      pattern: "block_start_string"
    - from: "src/reporting/math_pdf.py"
      to: "subprocess"
      via: "pdflatex compilation"
      pattern: "subprocess.run.*pdflatex"
---

<objective>
Build the math verification PDF generator that produces a LaTeX document with per-source-file sections containing plain-language summaries, code blocks, and LaTeX math formulas, plus an appendix of non-math files.

Purpose: Delivers MATH-01 (peer-review PDF with math documentation) and MATH-02 (AI-generated disclaimer footnote). The .tex generation works independently of pdflatex; PDF compilation is attempted if pdflatex is available.
Output: `src/reporting/math_pdf.py`, LaTeX template, and tests.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-reporting-and-math-verification/09-CONTEXT.md
@.planning/phases/09-reporting-and-math-verification/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LaTeX template and math content definitions</name>
  <files>
    src/reporting/templates/math_verification.tex
    src/reporting/math_pdf.py
  </files>
  <action>
Create `src/reporting/templates/math_verification.tex` using Jinja2 LaTeX-safe delimiters per RESEARCH.md Pattern 2:
- `block_start_string=r"\BLOCK{"`, `block_end_string="}"`, `variable_start_string=r"\VAR{"`, `variable_end_string="}"`
- `comment_start_string=r"\#{"`, `comment_end_string="}"`
- `line_statement_prefix="%%"`, `line_comment_prefix="%#"`

Template structure:
- `\documentclass[11pt,a4paper]{article}` with packages: inputenc(utf8), amsmath, amssymb, listings, hyperref, geometry(margin=1in), xcolor
- lstset for Python code: ttfamily small, breaklines, frame=single, numbers=left
- Title: "Mathematical Implementation Verification" with subtitle "DCSBM Transformer SVD Hallucination Prediction"
- Author: "Auto-generated for peer review"
- Date: `\VAR{generation_date}`
- After `\maketitle`: footnote using `\renewcommand{\thefootnote}{\fnsymbol{footnote}}` then `\footnotetext[1]{...}` with text: "This document was generated by AI (Claude). All LaTeX representations of mathematics require researcher sign-off before citation or publication." Per user decision: standard footnote, not prominent warning box.
- `\tableofcontents` then `\newpage`
- Loop over `math_sections`: `\BLOCK{for section in math_sections}` ... `\BLOCK{endfor}`
  - Each section: `\section{\VAR{section.title}}`
  - Plain-language summary paragraph: `\VAR{section.summary}` (per user decision: thorough summaries explaining what it computes, why it matters, how it connects)
  - `\subsection{Source Code}` with `\begin{lstlisting}` ... `\end{lstlisting}` containing `\VAR{section.code}`
  - `\subsection{Mathematical Formulation}` containing `\VAR{section.latex_math}` (per user decision: final implemented equations only, no derivation steps; symbols defined in context where first appearing)
  - `\newpage`
- Appendix: `\appendix` then `\section{Non-Mathematical Source Files}` with itemize list
  - `\BLOCK{for entry in appendix_files}` `\item \texttt{\VAR{entry.filename}} --- \VAR{entry.description}` `\BLOCK{endfor}`

Create `src/reporting/math_pdf.py` with:

1. **`MATH_SECTIONS`**: List of dicts defining the 15 math-heavy source files from RESEARCH.md inventory. Each entry has:
   - `file_path`: relative path (e.g., "src/evaluation/svd_metrics.py")
   - `title`: section title (e.g., "SVD Metric Functions")
   - `summary`: Thorough plain-language summary paragraph (per user decision: paragraph per file explaining what it computes, why it matters, how it connects to overall method)
   - `latex_math`: LaTeX math block with the key equations implemented in that file. Per user decision: final implemented equations only, no derivation. Per user decision: symbols defined in context where they first appear, no separate glossary. Include annotations linking math to code (e.g., "Line 42 implements..." or "The function \texttt{stable\_rank} computes...").

   The 15 files and their key math (from RESEARCH.md):
   - `src/evaluation/svd_metrics.py`: stable rank $\|M\|_F^2/\|M\|_2^2$, spectral entropy $-\sum p_i \log p_i$ where $p_i = \sigma_i/\sum\sigma$, spectral gaps $\sigma_k - \sigma_{k+1}$, condition number $\sigma_1/\sigma_n$, rank-1 residual $\|M - \sigma_1 u_1 v_1^T\|_F/\|M\|_F$, read-write alignment cosine, Grassmannian distance
   - `src/model/attention.py`: $\text{QK}^T/\sqrt{d}$, causal mask, softmax
   - `src/graph/dcsbm.py`: $P[i,j] = \theta_i \theta_j \omega[b_i,b_j]$, Bernoulli sampling
   - `src/graph/degree_correction.py`: $\theta_i \sim 1/\text{rank}^\alpha$, per-block normalization
   - `src/analysis/auroc_horizon.py`: Mann-Whitney U for AUROC, predictive horizon
   - `src/analysis/statistical_controls.py`: Holm-Bonferroni, BCa bootstrap, Cohen's d, Pearson correlation
   - `src/analysis/event_extraction.py`: contamination filtering, event stratification
   - `src/training/trainer.py`: cosine LR with warmup, cross-entropy loss
   - `src/model/transformer.py`: embeddings, residual scaling $1/\sqrt{2n}$, $W_vW_o = W_v^T W_o$
   - `src/evaluation/pipeline.py`: $AVW_o = (A \cdot V) \cdot W_o^T$, three SVD targets
   - `src/evaluation/behavioral.py`: 4-class classification, CSR lookup
   - `src/graph/jumpers.py`: $r = \text{round}(\text{scale} \cdot w)$
   - `src/graph/validation.py`: path verification via adjacency powers
   - `src/walk/generator.py`: random walk on directed graph
   - `src/training/data.py`: walk chunking into $w+1$ subsequences

2. **`APPENDIX_FILES`**: List of dicts for non-math files with `filename` and `description` (one-liner). Per user decision: appendix lists non-math files with filename + one-liner only.

3. **`_read_source_file(file_path: str) -> str`**: Read source file, return contents. Return placeholder string if file not found.

4. **`_create_latex_env() -> jinja2.Environment`**: Create Jinja2 environment with LaTeX-safe delimiters per Pattern 2 in RESEARCH.md.

5. **`generate_math_pdf(output_dir: str | Path) -> Path`**:
   - Build sections by reading each source file and combining with predefined summary + latex_math
   - Render .tex template via Jinja2
   - Write .tex to `{output_dir}/math_verification.tex`
   - Attempt `subprocess.run(["pdflatex", "-interaction=nonstopmode", "-output-directory", str(output_dir), tex_path])` twice (two passes for TOC)
   - If pdflatex not found (FileNotFoundError) or fails, log warning and return path to .tex file
   - If successful, return path to .pdf file
   - Clean up auxiliary files (.aux, .log, .toc, .out) on success
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -c "from src.reporting.math_pdf import generate_math_pdf, MATH_SECTIONS, APPENDIX_FILES; print(f'{len(MATH_SECTIONS)} math sections, {len(APPENDIX_FILES)} appendix files')"</automated>
  </verify>
  <done>math_pdf.py defines all 15 math-heavy file sections with summaries and LaTeX, plus appendix entries for non-math files; LaTeX template uses safe delimiters and renders without Jinja2 errors</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for math PDF generation and update exports</name>
  <files>
    tests/test_math_pdf.py
    src/reporting/__init__.py
  </files>
  <action>
Create `tests/test_math_pdf.py` with tests:

- `test_math_sections_complete`: Verify MATH_SECTIONS has exactly 15 entries matching the inventory in RESEARCH.md. Each entry has file_path, title, summary (non-empty string), latex_math (non-empty string).
- `test_appendix_files_complete`: Verify APPENDIX_FILES is non-empty, each entry has filename and description.
- `test_latex_env_creation`: Create the LaTeX Jinja2 environment, verify custom delimiters are set (block_start_string contains "BLOCK").
- `test_tex_generation`: Call generate_math_pdf() with a temp directory. Verify .tex file is created. Read .tex content and verify:
  - Contains "Mathematical Implementation Verification" (title)
  - Contains "researcher sign-off" (AI disclaimer footnote per MATH-02)
  - Contains "\\tableofcontents" (TOC)
  - Contains "\\begin{lstlisting}" (code blocks)
  - Contains at least one LaTeX math environment (\\begin{align} or \\[ or equation)
  - Contains "Non-Mathematical Source Files" (appendix)
- `test_tex_contains_all_sections`: Generate .tex, verify it contains a `\section{` for each MATH_SECTIONS entry title.
- `test_read_source_file_missing`: Verify _read_source_file with nonexistent path returns placeholder text, does not raise.
- `test_generate_math_pdf_no_pdflatex`: Mock subprocess.run to raise FileNotFoundError, verify generate_math_pdf returns path to .tex (not .pdf), does not crash.

Update `src/reporting/__init__.py` to also export `generate_math_pdf`.
  </action>
  <verify>
    <automated>cd /root/Repos/dcsbm-transformer && python -m pytest tests/test_math_pdf.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>All math PDF tests pass; generate_math_pdf produces valid .tex with all 15 sections, AI disclaimer, TOC, and appendix; gracefully handles missing pdflatex</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_math_pdf.py -x -v` -- all tests pass
2. `python -c "from src.reporting import generate_math_pdf"` -- import works
3. Generated .tex file compiles with pdflatex (if installed) or is valid LaTeX syntax
4. .tex contains AI-generated disclaimer footnote on title page
</verification>

<success_criteria>
- generate_math_pdf() produces .tex with 15 math sections + appendix (MATH-01)
- Title page footnote notes AI-generated LaTeX requiring researcher sign-off (MATH-02)
- Each section has: plain-language summary, code block, LaTeX math formulas
- Appendix lists non-math files with filename + one-liner
- .tex compiles to PDF when pdflatex available; graceful fallback when not
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-reporting-and-math-verification/09-03-SUMMARY.md`
</output>
